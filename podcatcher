#!/usr/bin/make -f

s ?= $(error Usage: podcatcher s=file.ini)
export timestamp = $(t)		# for `enclosures-print.rb`

src := $(dir $(realpath $(lastword $(MAKEFILE_LIST))))

MK := $(MAKE) --no-print-directory
mk := make --no-print-directory

.PHONY: run
run: download.mk
	$(MK) -f $<

.PHONY: download.mk
download.mk: enclosures
	xargs $(mk) -f $(src)/generate.mk < $< > $@

.PHONY: enclosures
enclosures: feeds
	ruby $(src)/enclosures-print.rb < $< > $@

.PHONY: feeds
feeds:
	$(MK) -f $(src)/feed-parse.mk `ruby $(src)/ini-parse.rb "$(s)"` > $@
